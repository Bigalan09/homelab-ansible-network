- name: Resolve garage Wi-Fi policy
  ansible.builtin.set_fact:
    garage_mgmt_ssid_effective: "{{ garage_mgmt_ssid | default(garage_mgmt_ssid_default) }}"
    garage_wifi_radios_to_disable_effective: "{{ garage_wifi_radios_to_disable | default(garage_wifi_radios_to_disable_default) }}"
    garage_test_mode_effective: "{{ garage_test_mode | default(garage_test_mode_default) }}"
    garage_test_repeater_network_effective: "{{ garage_test_repeater_network | default(garage_test_repeater_network_default) }}"
    garage_test_repeater_radio_effective: "{{ garage_test_repeater_radio | default(garage_test_repeater_radio_default) }}"
    garage_test_repeater_encryption_effective: "{{ garage_test_repeater_encryption | default(garage_test_repeater_encryption_default) }}"
    garage_test_repeater_radios_effective: "{{ garage_test_repeater_radios | default(garage_test_repeater_radios_default) }}"
    garage_test_repeater_encryptions_effective: "{{ garage_test_repeater_encryptions | default(garage_test_repeater_encryptions_default) }}"
    garage_test_tailscale_hosts_effective: "{{ garage_test_tailscale_hosts | default(garage_test_tailscale_hosts_default) }}"
    garage_test_uplink_wait_seconds_effective: "{{ garage_test_uplink_wait_seconds | default(garage_test_uplink_wait_seconds_default) }}"
    garage_test_uplink_poll_interval_seconds_effective: "{{ garage_test_uplink_poll_interval_seconds | default(garage_test_uplink_poll_interval_seconds_default) }}"
    garage_test_repeater_ssid_effective: "{{ garage_test_repeater_ssid | default(vault_garage_test_repeater_ssid | default('')) }}"
    garage_test_repeater_password_effective: "{{ garage_test_repeater_password | default(vault_garage_test_repeater_password | default('')) }}"
    garage_wan_proto_effective: "{{ garage_wan_proto | default(garage_wan_proto_default) }}"
    garage_wan_pppoe_mtu_effective: "{{ garage_wan_pppoe_mtu | default(garage_wan_pppoe_mtu_default) }}"
    garage_wan_vlan_tag_effective: "{{ garage_wan_vlan_tag | default(garage_wan_vlan_tag_default) }}"
    garage_wan_parent_if_effective: "{{ garage_wan_parent_if | default('') }}"
    garage_wan_pppoe_service_effective: "{{ garage_wan_pppoe_service | default('') }}"
    garage_wan_pppoe_username_effective: "{{ garage_wan_pppoe_username | default(vault_garage_wan_pppoe_username | default('')) }}"
    garage_wan_pppoe_password_effective: "{{ garage_wan_pppoe_password | default(vault_garage_wan_pppoe_password | default('')) }}"

- name: Validate PPPoE credentials are available
  ansible.builtin.assert:
    that:
      - garage_wan_pppoe_username_effective | length > 0
      - garage_wan_pppoe_password_effective | length > 0
      - garage_wan_vlan_tag_effective | length > 0
    fail_msg: >-
      garage_wan_proto is pppoe but PPPoE requirements are missing.
      Set vault_garage_wan_pppoe_username and
      vault_garage_wan_pppoe_password in group_vars/all/vault.yml,
      and set garage_wan_vlan_tag (e.g. 911) in network.yml.
  when:
    - garage_wan_proto_effective == "pppoe"
    - not (garage_test_mode_effective | bool)

- name: Validate test-mode repeater credentials are available
  ansible.builtin.assert:
    that:
      - garage_test_repeater_ssid_effective | length > 0
      - garage_test_repeater_password_effective | length > 0
    fail_msg: >-
      garage_test_mode is enabled but repeater credentials are missing.
      Set vault_garage_test_repeater_ssid and
      vault_garage_test_repeater_password in group_vars/all/vault.yml.
  when: garage_test_mode_effective | bool

