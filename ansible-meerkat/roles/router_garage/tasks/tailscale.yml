- name: Ensure tailscale packages are installed (best effort)
  ansible.builtin.raw: |
    if ! command -v tailscale >/dev/null 2>&1; then
      opkg update && opkg install kmod-tun tailscale
    fi
  when: tailscale_enable_effective | bool
  register: tailscale_install_result
  failed_when: false

- name: Enable and start tailscale service (best effort)
  ansible.builtin.raw: |
    if command -v tailscale >/dev/null 2>&1; then
      /etc/init.d/tailscale enable
      /etc/init.d/tailscale restart || /etc/init.d/tailscale start
    fi
  when: tailscale_enable_effective | bool
  register: tailscale_service_result
  failed_when: false

- name: Configure tailscale exit-node and route advertisements (best effort)
  ansible.builtin.raw: |
    if command -v tailscale >/dev/null 2>&1; then
      tailscale up \
        --hostname='router-garage' \
        --advertise-exit-node \
        --advertise-routes='{{ tailscale_advertise_routes_csv }}' \
        --accept-routes=true \
        --accept-dns=false
    fi
  when: tailscale_enable_effective | bool
  register: tailscale_up_result
  failed_when: false

- name: Configure tailscale with auth key or OAuth client secret when required (best effort)
  ansible.builtin.raw: |
    if command -v tailscale >/dev/null 2>&1; then
      tailscale up \
        --auth-key='{{ tailscale_auth_key_for_up_effective }}' \
        --hostname='router-garage' \
        --advertise-exit-node \
        --advertise-routes='{{ tailscale_advertise_routes_csv }}' \
        {% if tailscale_use_oauth_secret_authkey_effective | bool and tailscale_oauth_tags_csv | length > 0 %}
        --advertise-tags='{{ tailscale_oauth_tags_csv }}' \
        {% endif %}
        --accept-routes=true \
        --accept-dns=false
    fi
  when:
    - tailscale_enable_effective | bool
    - tailscale_up_result is defined
    - tailscale_up_result.rc != 0
    - tailscale_auth_key_for_up_effective | length > 0
  register: tailscale_up_authkey_result
  failed_when: false
  no_log: true

- name: Request tailscale OAuth access token (best effort)
  ansible.builtin.uri:
    url: "https://api.tailscale.com/api/v2/oauth/token"
    method: POST
    force_basic_auth: true
    url_username: "{{ tailscale_oauth_client_id_effective }}"
    url_password: "{{ tailscale_oauth_client_secret_effective }}"
    body_format: form-urlencoded
    body:
      grant_type: "client_credentials"
    return_content: true
    status_code: 200
  delegate_to: localhost
  become: false
  register: tailscale_oauth_token_result
  failed_when: false
  no_log: true
  when:
    - tailscale_enable_effective | bool
    - tailscale_up_result is defined
    - tailscale_up_result.rc != 0
    - tailscale_auth_key_effective | length == 0
    - tailscale_oauth_client_id_effective | length > 0
    - tailscale_oauth_client_secret_effective | length > 0
    - (tailscale_up_authkey_result.rc | default(1)) != 0

- name: Show tailscale OAuth token diagnostics (best effort)
  ansible.builtin.debug:
    msg: >-
      Tailscale OAuth token request did not return a usable access token.
      status={{ tailscale_oauth_token_result.status | default('unknown') }}
      response={{ tailscale_oauth_token_result.json | default(tailscale_oauth_token_result.content | default('no body')) }}
  when:
    - tailscale_enable_effective | bool
    - tailscale_up_result is defined
    - tailscale_up_result.rc != 0
    - tailscale_auth_key_effective | length == 0
    - tailscale_oauth_client_id_effective | length > 0
    - tailscale_oauth_client_secret_effective | length > 0
    - tailscale_oauth_token_result is defined
    - (tailscale_oauth_token_result.status | default(0)) != 200 or (tailscale_oauth_token_result.json is not defined) or (tailscale_oauth_token_result.json.access_token is not defined)

- name: Create tailscale auth key from OAuth credentials (best effort)
  ansible.builtin.uri:
    url: "https://api.tailscale.com/api/v2/tailnet/{{ tailscale_oauth_tailnet_effective }}/keys"
    method: POST
    headers:
      Authorization: "Bearer {{ tailscale_oauth_token_result.json.access_token }}"
      Content-Type: "application/json"
    body_format: raw
    body: |
      {
        "capabilities": {
          "devices": {
            "create": {
              "reusable": true,
              "ephemeral": false,
              "preauthorized": true,
              "tags": {{ tailscale_oauth_tags_effective | to_json }}
            }
          }
        },
        "expirySeconds": {{ tailscale_oauth_key_expiry_seconds_effective | int }},
        "description": "ansible-router-garage-bootstrap"
      }
    return_content: true
    status_code:
      - 200
      - 201
  delegate_to: localhost
  become: false
  register: tailscale_oauth_key_result
  failed_when: false
  no_log: true
  when:
    - tailscale_enable_effective | bool
    - tailscale_oauth_token_result is defined
    - tailscale_oauth_token_result.status | default(0) == 200
    - tailscale_oauth_token_result.json.access_token is defined

- name: Store generated tailscale auth key
  ansible.builtin.set_fact:
    tailscale_generated_auth_key_effective: "{{ tailscale_oauth_key_result.json.key | default('') }}"
  no_log: true
  when:
    - tailscale_oauth_key_result is defined
    - tailscale_oauth_key_result.status | default(0) in [200, 201]
    - tailscale_oauth_key_result.json.key is defined

- name: Show tailscale OAuth key creation diagnostics (best effort)
  ansible.builtin.debug:
    msg: >-
      Tailscale OAuth key creation did not return a usable key.
      status={{ tailscale_oauth_key_result.status | default('unknown') }}
      response={{ tailscale_oauth_key_result.json | default(tailscale_oauth_key_result.content | default('no body')) }}
  when:
    - tailscale_enable_effective | bool
    - tailscale_up_result is defined
    - tailscale_up_result.rc != 0
    - tailscale_auth_key_effective | length == 0
    - tailscale_oauth_key_result is defined
    - not (tailscale_oauth_key_result is skipped)
    - tailscale_generated_auth_key_effective | length == 0

- name: Configure tailscale with generated OAuth auth key (best effort)
  ansible.builtin.raw: |
    if command -v tailscale >/dev/null 2>&1; then
      tailscale up \
        --auth-key='{{ tailscale_generated_auth_key_effective }}' \
        --hostname='router-garage' \
        --advertise-exit-node \
        --advertise-routes='{{ tailscale_advertise_routes_csv }}' \
        --accept-routes=true \
        --accept-dns=false
    fi
  when:
    - tailscale_enable_effective | bool
    - tailscale_up_result is defined
    - tailscale_up_result.rc != 0
    - tailscale_auth_key_effective | length == 0
    - tailscale_generated_auth_key_effective | length > 0
  register: tailscale_up_oauth_key_result
  failed_when: false
  no_log: true

- name: Show tailscale auth hint when not yet connected
  ansible.builtin.debug:
    msg: >-
      Tailscale is enabled but still needs authentication.
      Provide tailscale_auth_key in Vault (static auth key or OAuth
      client secret), or provide
      vault_tailscale_oauth_client_id and
      vault_tailscale_oauth_client_secret in Vault. If using OAuth client
      secret auth, ensure tailscale_oauth_tags are permitted by tagOwners.
      Or run on router:
      tailscale up --hostname=router-garage --advertise-exit-node
      --advertise-routes='{{ tailscale_advertise_routes_csv }}'
  when:
    - tailscale_enable_effective | bool
    - tailscale_up_result is defined
    - tailscale_up_result.rc != 0
    - (tailscale_up_authkey_result.rc | default(1)) != 0
    - tailscale_generated_auth_key_effective | length == 0 or (tailscale_up_oauth_key_result.rc | default(1)) != 0

