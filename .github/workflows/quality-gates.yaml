---
name: Quality gates

on:
  pull_request:

jobs:
  ansible-quality:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install ansible ansible-lint yamllint

      - name: Install Ansible collections
        run: ansible-galaxy collection install -r dependencies/requirements.yaml

      - name: Prepare non-secret vault for syntax checks
        run: cp inventory/vault.example.yaml inventory/vault.yaml

      - name: ansible-lint
        env:
          ANSIBLE_VAULT_PASSWORD_FILE: scripts/vault-pass-ci.sh
        run: ansible-lint

      - name: yamllint
        run: yamllint .

      - name: Inventory loads
        env:
          ANSIBLE_VAULT_PASSWORD_FILE: scripts/vault-pass-ci.sh
        run: ansible-inventory -i inventory/hosts.yaml --list > /dev/null

      - name: Syntax check all playbooks
        env:
          ANSIBLE_VAULT_PASSWORD_FILE: scripts/vault-pass-ci.sh
        run: |
          for playbook in playbooks/*.yaml; do
            echo "Checking ${playbook}"
            ansible-playbook -i inventory/hosts.yaml --syntax-check "${playbook}"
          done
