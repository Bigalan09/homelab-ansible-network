---
- name: Resolve AP-repeater network settings
  ansible.builtin.set_fact:
    ap_repeater_ip_effective: "{{ ap_ip }}"
    ap_repeater_netmask_effective: "{{ ap_netmask }}"
    ap_repeater_gateway_effective: "{{ ap_gateway }}"
    network_wifi_country_effective: "{{ wifi_country | default(network.wifi.country) }}"
    network_wifi_channels_effective: "{{ wifi_channels | default(network.wifi.channels | default({})) }}"
    ap_repeater_ssids_effective: "{{ ssids | default(network.ap_repeater.ssids) }}"
    ap_lan_management_vlan_effective: "{{ ap_lan_management_vlan | default(network.ap_repeater.lan_management_vlan | default(ap_lan_management_vlan_default)) }}"
    ap_backhaul_vlan_ids_effective: "{{ (ssids | default(network.ap_repeater.ssids)) | map(attribute='vlan_id') | map('int') | unique | sort }}"

- name: Set AP hostname and static management network
  ansible.builtin.raw: |
    uci set system.@system[0].hostname='ap-repeater'
    uci set network.lan.proto='static'
    uci set network.lan.ipaddr='{{ ap_repeater_ip_effective }}'
    uci set network.lan.netmask='{{ ap_repeater_netmask_effective }}'
    uci set network.lan.gateway='{{ ap_repeater_gateway_effective }}'
    uci set network.lan.dns='{{ ap_repeater_gateway_effective }}'

- name: Disable AP WAN and WAN6 interfaces to prevent same-subnet conflicts
  ansible.builtin.raw: |
    uci set network.wan.proto='none'
    uci -q delete network.wan.device
    uci -q delete network.wan.ipaddr
    uci -q delete network.wan.netmask
    uci -q delete network.wan.gateway
    uci -q delete network.wan.dns
    uci set network.wan6.proto='none'
    uci -q delete network.wan6.device

- name: Ensure WAN firewall zone has no attached interfaces on AP
  ansible.builtin.raw: |
    idx=0
    while uci -q get firewall.@zone[$idx] >/dev/null 2>&1; do
      if [ "$(uci -q get firewall.@zone[$idx].name)" = "wan" ]; then
        uci -q delete firewall.@zone[$idx].network
        break
      fi
      idx=$((idx+1))
    done

- name: Disable DHCP server on AP LAN
  ansible.builtin.raw: |
    uci set dhcp.lan.ignore='1'

- name: Configure bridge VLAN filtering and trunk tagging on AP LAN bridge
  ansible.builtin.raw: |
    br_idx=''
    idx=0
    while uci -q get network.@device[$idx] >/dev/null 2>&1; do
      if [ "$(uci -q get network.@device[$idx].name)" = 'br-lan' ]; then
        br_idx="$idx"
        break
      fi
      idx=$((idx+1))
    done

    if [ -z "$br_idx" ]; then
      echo "Unable to locate br-lan device section in UCI network config." >&2
      exit 22
    fi

    uci set network.@device[$br_idx].vlan_filtering='1'

    idx=0
    while uci -q get network.@bridge-vlan[$idx] >/dev/null 2>&1; do
      uci -q delete network.@bridge-vlan[$idx]
    done

    lan_ports=''
    uci_ports="$(uci -q get network.@device[$br_idx].ports 2>/dev/null | tr '\n' ' ' || true)"
    if [ -n "$uci_ports" ]; then
      lan_ports="$uci_ports"
    fi

    if [ -z "$lan_ports" ]; then
      runtime_ports="$(bridge link show master br-lan 2>/dev/null | awk -F': ' '/^[0-9]+: / {split($2, a, " "); sub(/@.*/, "", a[1]); if (a[1] != "br-lan") print a[1]}' | tr '\n' ' ')"
      if [ -n "$runtime_ports" ]; then
        lan_ports="$runtime_ports"
        uci -q delete network.@device[$br_idx].ports
        for port in $lan_ports; do
          uci add_list network.@device[$br_idx].ports="$port"
        done
      fi
    fi

    if [ -z "$lan_ports" ]; then
      echo "br-lan has no configured member ports." >&2
      exit 23
    fi

    uci add network bridge-vlan >/dev/null
    uci set network.@bridge-vlan[-1].device='br-lan'
    uci set network.@bridge-vlan[-1].vlan='{{ ap_lan_management_vlan_effective }}'
    for port in $lan_ports; do
      uci add_list network.@bridge-vlan[-1].ports="$port:u*"
    done

    {% for vlan_id in ap_backhaul_vlan_ids_effective if (vlan_id | int) != (ap_lan_management_vlan_effective | int) %}
    uci add network bridge-vlan >/dev/null
    uci set network.@bridge-vlan[-1].device='br-lan'
    uci set network.@bridge-vlan[-1].vlan='{{ vlan_id }}'
    for port in $lan_ports; do
      uci add_list network.@bridge-vlan[-1].ports="$port:t"
    done
    {% endfor %}

- name: Build VLAN bridge interfaces for AP SSID backhaul
  ansible.builtin.raw: |
    {% for vlan_id in ap_backhaul_vlan_ids_effective if (vlan_id | int) != (ap_lan_management_vlan_effective | int) %}
    uci -q delete network.ap_vlan{{ vlan_id }}
    uci set network.ap_vlan{{ vlan_id }}='interface'
    uci set network.ap_vlan{{ vlan_id }}.proto='none'
    uci set network.ap_vlan{{ vlan_id }}.device='br-lan.{{ vlan_id }}'
    {% endfor %}

- name: Configure country code and reset wifi-iface sections
  ansible.builtin.raw: |
    wifi_devices="$(uci -q show wireless | sed -n "s/^wireless\\.\\([^.=]*\\)=wifi-device$/\\1/p")"
    channel_2g='{{ network_wifi_channels_effective.get("2g", "") }}'
    channel_5g='{{ network_wifi_channels_effective.get("5g", "") }}'
    channel_6g='{{ network_wifi_channels_effective.get("6g", "") }}'
    for dev in $wifi_devices; do
      uci -q set wireless."$dev".country='{{ network_wifi_country_effective }}'
      uci -q set wireless."$dev".disabled='0'
      band="$(uci -q get wireless."$dev".band || true)"
      desired_channel=''
      case "$band" in
        2g) desired_channel="$channel_2g" ;;
        5g) desired_channel="$channel_5g" ;;
        6g) desired_channel="$channel_6g" ;;
      esac
      if [ -n "$desired_channel" ]; then
        uci -q set wireless."$dev".channel="$desired_channel"
      fi
    done
    wifi_iface_sections="$(uci -q show wireless | sed -n "s/^wireless\\.\\([^.@][^.=]*\\)=wifi-iface$/\\1/p")"
    for iface in $wifi_iface_sections; do
      uci -q delete wireless."$iface"
    done
    while uci -q get wireless.@wifi-iface[0] >/dev/null 2>&1; do
      uci -q delete wireless.@wifi-iface[0]
    done

- name: Create named SSID to VLAN mappings from vars
  ansible.builtin.raw: |
    wifi_devices="$(uci -q show wireless | sed -n "s/^wireless\\.\\([^.=]*\\)=wifi-device$/\\1/p")"
    first_dev="$(printf '%s\n' "$wifi_devices" | sed -n '1p')"
    second_dev="$(printf '%s\n' "$wifi_devices" | sed -n '2p')"
    mtk_like_device=0
    dev_2g=''
    dev_5g=''
    dev_6g=''
    for dev in $wifi_devices; do
      if printf '%s\n' "$dev" | grep -Eq '^mt[0-9]+'; then
        mtk_like_device=1
      fi
      band="$(uci -q get wireless."$dev".band || true)"
      case "$band" in
        2g) [ -z "$dev_2g" ] && dev_2g="$dev" ;;
        5g) [ -z "$dev_5g" ] && dev_5g="$dev" ;;
        6g) [ -z "$dev_6g" ] && dev_6g="$dev" ;;
      esac
    done
    mtk_2g_idx=0
    mtk_5g_idx=0
    mtk_6g_idx=0
    is_wifi_device() {
      [ -n "${1:-}" ] || return 1
      uci -q show wireless."$1" 2>/dev/null | grep -q "^wireless\\.$1=wifi-device$"
    }

    {% for ssid in ap_repeater_ssids_effective %}
    requested_dev='{{ ssid.device }}'
    resolved_dev="$requested_dev"

    if ! is_wifi_device "$resolved_dev"; then
      case "$requested_dev" in
        radio0) resolved_dev="${dev_2g:-$first_dev}" ;;
        radio1) resolved_dev="${dev_5g:-$second_dev}" ;;
        radio2) resolved_dev="$dev_6g" ;;
      esac
    fi

    if ! is_wifi_device "$resolved_dev"; then
      echo "Skipping SSID '{{ ssid.name }}': wireless device '$requested_dev' not found." >&2
      uci -q delete wireless.{{ ssid.name }}
      continue
    fi

    uci -q delete wireless.{{ ssid.name }}
    uci set wireless.{{ ssid.name }}='wifi-iface'
    uci set wireless.{{ ssid.name }}.device="$resolved_dev"
    uci set wireless.{{ ssid.name }}.mode='ap'
    uci set wireless.{{ ssid.name }}.network='ap_vlan{{ ssid.vlan_id }}'
    uci set wireless.{{ ssid.name }}.ssid='{{ ssid.ssid }}'
    uci set wireless.{{ ssid.name }}.encryption='{{ ssid.encryption }}'
    uci set wireless.{{ ssid.name }}.key='{{ ssid.key }}'
    uci set wireless.{{ ssid.name }}.disabled='0'
    if [ "$mtk_like_device" -eq 1 ]; then
      band="$(uci -q get wireless."$resolved_dev".band || true)"
      case "$band" in
        2g)
          uci set wireless.{{ ssid.name }}.ifname="ra${mtk_2g_idx}"
          mtk_2g_idx=$((mtk_2g_idx + 1))
          ;;
        5g)
          uci set wireless.{{ ssid.name }}.ifname="rax${mtk_5g_idx}"
          mtk_5g_idx=$((mtk_5g_idx + 1))
          ;;
        6g)
          uci set wireless.{{ ssid.name }}.ifname="rai${mtk_6g_idx}"
          mtk_6g_idx=$((mtk_6g_idx + 1))
          ;;
        *)
          uci -q delete wireless.{{ ssid.name }}.ifname
          ;;
      esac
    else
      uci -q delete wireless.{{ ssid.name }}.ifname
    fi
    {% if ssid.isolate is defined %}
    uci set wireless.{{ ssid.name }}.isolate='{{ ssid.isolate }}'
    {% else %}
    uci -q delete wireless.{{ ssid.name }}.isolate
    {% endif %}
    {% endfor %}

- name: Commit UCI changes
  ansible.builtin.raw: |
    uci commit system
    uci commit network
    uci commit dhcp
    uci commit wireless

- name: Reload OpenWrt services
  ansible.builtin.raw: |
    /etc/init.d/network restart || /etc/init.d/network reload
    wifi reload || wifi
    /etc/init.d/dnsmasq restart
