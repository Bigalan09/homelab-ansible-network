---
- name: Calculate rollback trigger time (UTC on control node)
  ansible.builtin.set_fact:
    crs310_rollback_start_time: "{{ lookup('pipe', 'date -u -d \"+' ~ (crs310_rollback_delay_minutes | int | string) ~ ' minutes\" +%H:%M:%S') }}"

- name: Configure CRS3xx bridge VLAN filtering topology with timed rollback safety
  block:
    - name: Install rollback script and scheduler guard before VLAN filtering changes
      community.routeros.command:
        commands:
          - /system script remove [find where name="{{ crs310_rollback_script_name }}"]
          - /system scheduler remove [find where name="{{ crs310_rollback_scheduler_name }}"]
          - >-
            /system script add name="{{ crs310_rollback_script_name }}" source="/interface bridge set [find where name=\"{{ crs310_bridge_name }}\"] vlan-filtering=no; /system scheduler remove [find where name=\"{{ crs310_rollback_scheduler_name }}\"]; /system script remove [find where name=\"{{ crs310_rollback_script_name }}\"]"
          - >-
            /system scheduler add name="{{ crs310_rollback_scheduler_name }}" start-time="{{ crs310_rollback_start_time }}" interval=0s on-event="/system script run {{ crs310_rollback_script_name }}"

    - name: Ensure bridge exists with vlan-filtering disabled (safe staging)
      community.routeros.command:
        commands:
          - >-
            :if ([:len [/interface bridge find where name="{{ crs310_bridge_name }}"]] = 0) do={/interface bridge add name="{{ crs310_bridge_name }}" vlan-filtering=no}
          - /interface bridge set [find where name="{{ crs310_bridge_name }}"] vlan-filtering=no

    - name: Ensure bridge ports exist with required PVIDs
      community.routeros.command:
        commands:
          - >-
            :if ([:len [/interface bridge port find where bridge="{{ crs310_bridge_name }}" and interface="{{ crs310_uplink_interface }}"]] = 0) do={/interface bridge port add bridge="{{ crs310_bridge_name }}" interface="{{ crs310_uplink_interface }}" pvid={{ crs310_uplink_pvid }} ingress-filtering=yes frame-types=admit-only-vlan-tagged} else={/interface bridge port set [find where bridge="{{ crs310_bridge_name }}" and interface="{{ crs310_uplink_interface }}"] pvid={{ crs310_uplink_pvid }} ingress-filtering=yes frame-types=admit-only-vlan-tagged}
          - >-
            :if ([:len [/interface bridge port find where bridge="{{ crs310_bridge_name }}" and interface="{{ crs310_ap_interface }}"]] = 0) do={/interface bridge port add bridge="{{ crs310_bridge_name }}" interface="{{ crs310_ap_interface }}" pvid={{ crs310_ap_management_pvid }} ingress-filtering=yes frame-types=admit-all} else={/interface bridge port set [find where bridge="{{ crs310_bridge_name }}" and interface="{{ crs310_ap_interface }}"] pvid={{ crs310_ap_management_pvid }} ingress-filtering=yes frame-types=admit-all}

    - name: Ensure trusted access ports exist with PVID 10
      community.routeros.command:
        commands:
          - >-
            :if ([:len [/interface bridge port find where bridge="{{ crs310_bridge_name }}" and interface="{{ item }}"]] = 0) do={/interface bridge port add bridge="{{ crs310_bridge_name }}" interface="{{ item }}" pvid={{ crs310_trusted_access_pvid }} ingress-filtering=yes frame-types=admit-only-untagged-and-priority-tagged} else={/interface bridge port set [find where bridge="{{ crs310_bridge_name }}" and interface="{{ item }}"] pvid={{ crs310_trusted_access_pvid }} ingress-filtering=yes frame-types=admit-only-untagged-and-priority-tagged}
      loop: "{{ crs310_access_interfaces }}"

    - name: Configure bridge VLAN table entries (CRS3xx offload-compatible)
      community.routeros.command:
        commands:
          - >-
            :if ([:len [/interface bridge vlan find where bridge="{{ crs310_bridge_name }}" and vlan-ids={{ item }}]] = 0) do={/interface bridge vlan add bridge="{{ crs310_bridge_name }}" vlan-ids={{ item }} tagged={{ crs310_tagged_by_vlan[item] | join(',') }}} else={/interface bridge vlan set [find where bridge="{{ crs310_bridge_name }}" and vlan-ids={{ item }}] tagged={{ crs310_tagged_by_vlan[item] | join(',') }}}
      loop: "{{ crs310_vlan_ids }}"

    - name: Ensure management VLAN interface exists on bridge
      community.routeros.command:
        commands:
          - >-
            :if ([:len [/interface vlan find where name="{{ crs310_mgmt_vlan_interface }}"]] = 0) do={/interface vlan add name="{{ crs310_mgmt_vlan_interface }}" interface="{{ crs310_bridge_name }}" vlan-id={{ crs310_mgmt_vlan_id }}} else={/interface vlan set [find where name="{{ crs310_mgmt_vlan_interface }}"] interface="{{ crs310_bridge_name }}" vlan-id={{ crs310_mgmt_vlan_id }}}

    - name: Ensure management IP is assigned to VLAN interface
      community.routeros.command:
        commands:
          - >-
            :if ([:len [/ip address find where interface="{{ crs310_mgmt_vlan_interface }}"]] = 0) do={/ip address add address="{{ crs310_mgmt_ip_cidr }}" interface="{{ crs310_mgmt_vlan_interface }}"} else={/ip address set [find where interface="{{ crs310_mgmt_vlan_interface }}"] address="{{ crs310_mgmt_ip_cidr }}" interface="{{ crs310_mgmt_vlan_interface }}"}

    - name: Ensure default route is present for management reachability
      community.routeros.command:
        commands:
          - >-
            :if ([:len [/ip route find where dst-address="0.0.0.0/0"]] = 0) do={/ip route add dst-address=0.0.0.0/0 gateway="{{ crs310_mgmt_gateway }}"} else={/ip route set [find where dst-address="0.0.0.0/0"] gateway="{{ crs310_mgmt_gateway }}"}

    - name: Enable bridge VLAN filtering as the final configuration step
      community.routeros.command:
        commands:
          - /interface bridge set [find where name="{{ crs310_bridge_name }}"] vlan-filtering=yes

    - name: Remove rollback scheduler and script after successful completion
      community.routeros.command:
        commands:
          - /system scheduler remove [find where name="{{ crs310_rollback_scheduler_name }}"]
          - /system script remove [find where name="{{ crs310_rollback_script_name }}"]

  rescue:
    - name: Keep/trigger safe fallback if an Ansible task fails before completion
      community.routeros.command:
        commands:
          - /interface bridge set [find where name="{{ crs310_bridge_name }}"] vlan-filtering=no
