- name: Resolve garage Wi-Fi policy
  ansible.builtin.set_fact:
    garage_mgmt_ssid_effective: "{{ garage_mgmt_ssid | default(network.garage.mgmt_ssid | default(garage_mgmt_ssid_default)) }}"
    garage_wifi_radios_to_disable_effective: "{{ garage_wifi_radios_to_disable | default(network.garage.radios_to_disable | default(garage_wifi_radios_to_disable_default)) }}"
    garage_test_mode_effective: "{{ garage_test_mode | default(network.garage.test_mode.enabled | default(garage_test_mode_default)) }}"
    garage_test_repeater_network_effective: "{{ garage_test_repeater_network | default(network.garage.test_mode.repeater.network | default(garage_test_repeater_network_default)) }}"
    garage_test_repeater_radio_effective: "{{ garage_test_repeater_radio | default(network.garage.test_mode.repeater.radio | default(garage_test_repeater_radio_default)) }}"
    garage_test_repeater_encryption_effective: "{{ garage_test_repeater_encryption | default(network.garage.test_mode.repeater.encryption | default(garage_test_repeater_encryption_default)) }}"
    garage_test_repeater_radios_effective: "{{ garage_test_repeater_radios | default(network.garage.test_mode.repeater.radios | default(garage_test_repeater_radios_default)) }}"
    garage_test_repeater_encryptions_effective: "{{ garage_test_repeater_encryptions | default(network.garage.test_mode.repeater.encryptions | default(garage_test_repeater_encryptions_default)) }}"
    garage_test_tailscale_hosts_effective: "{{ garage_test_tailscale_hosts | default(network.garage.test_mode.tailscale_hosts | default(garage_test_tailscale_hosts_default)) }}"
    garage_test_uplink_wait_seconds_effective: "{{ garage_test_uplink_wait_seconds | default(network.garage.test_mode.uplink_wait_seconds | default(garage_test_uplink_wait_seconds_default)) }}"
    garage_test_uplink_poll_interval_seconds_effective: "{{ garage_test_uplink_poll_interval_seconds | default(network.garage.test_mode.uplink_poll_interval_seconds | default(garage_test_uplink_poll_interval_seconds_default)) }}"
    garage_test_repeater_ssid_effective: "{{ garage_test_repeater_ssid | default(vault_garage_test_repeater_ssid | default('')) }}"
    garage_test_repeater_password_effective: "{{ garage_test_repeater_password | default(vault_garage_test_repeater_password | default('')) }}"
    garage_wan_proto_effective: "{{ garage_wan_proto | default(network.garage.wan.proto | default(garage_wan_proto_default)) }}"
    garage_wan_pppoe_mtu_effective: "{{ garage_wan_pppoe_mtu | default(network.garage.wan.pppoe.mtu | default(garage_wan_pppoe_mtu_default)) }}"
    garage_wan_vlan_tag_effective: "{{ garage_wan_vlan_tag | default(network.garage.wan.pppoe.vlan_tag | default(garage_wan_vlan_tag_default)) }}"
    garage_wan_parent_if_effective: "{{ garage_wan_parent_if | default(network.garage.wan.pppoe.parent_if | default('')) }}"
    garage_wan_pppoe_service_effective: "{{ garage_wan_pppoe_service | default(network.garage.wan.pppoe.service | default('')) }}"
    garage_wan_pppoe_username_effective: "{{ garage_wan_pppoe_username | default(vault_garage_wan_pppoe_username | default('')) }}"
    garage_wan_pppoe_password_effective: "{{ garage_wan_pppoe_password | default(vault_garage_wan_pppoe_password | default('')) }}"
    network_vlans_effective: "{{ vlans | default(network.vlans) }}"
    network_forwarding_rules_effective: "{{ forwarding_rules | default(network.forwarding_rules) }}"
    garage_lan_management_vlan_effective: "{{ garage_lan_management_vlan | default(network.garage.lan_management_vlan | default(garage_lan_management_vlan_default)) }}"

- name: Validate PPPoE credentials are available
  ansible.builtin.assert:
    that:
      - garage_wan_pppoe_username_effective | length > 0
      - garage_wan_pppoe_password_effective | length > 0
      - garage_wan_vlan_tag_effective | length > 0
    fail_msg: >-
      garage_wan_proto is pppoe but PPPoE requirements are missing.
      Set vault_garage_wan_pppoe_username and
      vault_garage_wan_pppoe_password in inventory/vault.yaml,
      and set network.garage.wan.pppoe.vlan_tag (e.g. 911) in inventory/network.yaml.
  when:
    - garage_wan_proto_effective == "pppoe"
    - not (garage_test_mode_effective | bool)

- name: Validate test-mode repeater credentials are available
  ansible.builtin.assert:
    that:
      - garage_test_repeater_ssid_effective | length > 0
      - garage_test_repeater_password_effective | length > 0
    fail_msg: >-
      garage_test_mode is enabled but repeater credentials are missing.
      Set vault_garage_test_repeater_ssid and
      vault_garage_test_repeater_password in inventory/vault.yaml.
  when: garage_test_mode_effective | bool

