- name: Verify WAN and internet reachability before disabling gateway-router Wi-Fi
  ansible.builtin.raw: |
    if [ "{{ gateway_router_test_mode_effective | ternary('true', 'false') }}" = "true" ]; then
      uplink_up="$(ifstatus {{ gateway_router_test_repeater_network_effective }} 2>/dev/null | jsonfilter -e '@.up' 2>/dev/null || echo false)"
    else
      uplink_up="$(ifstatus wan 2>/dev/null | jsonfilter -e '@.up' 2>/dev/null || echo false)"
    fi
    if [ "$uplink_up" != "true" ]; then
      exit 2
    fi
    ping -c1 -W3 8.8.8.8 >/dev/null 2>&1 || ping -c1 -W3 1.1.1.1 >/dev/null 2>&1
  register: gateway_router_wan_internet_check
  changed_when: false
  failed_when: false

- name: Disable gateway-router 2.4/5 GHz radios after WAN/internet confirmation
  ansible.builtin.raw: |
    wifi_devices="$(uci -q show wireless | sed -n "s/^wireless\\.\\([^.=]*\\)=wifi-device$/\\1/p")"
    dev_2g=''
    dev_5g=''
    dev_6g=''
    for dev in $wifi_devices; do
      band="$(uci -q get wireless."$dev".band || true)"
      case "$band" in
        2g) [ -z "$dev_2g" ] && dev_2g="$dev" ;;
        5g) [ -z "$dev_5g" ] && dev_5g="$dev" ;;
        6g) [ -z "$dev_6g" ] && dev_6g="$dev" ;;
      esac
    done
    resolve_radio() {
      requested="${1:-}"
      [ -n "$requested" ] || return 1
      if uci -q get wireless."$requested" >/dev/null 2>&1; then
        printf '%s\n' "$requested"
        return 0
      fi
      case "$requested" in
        radio0) [ -n "$dev_2g" ] && printf '%s\n' "$dev_2g" && return 0 ;;
        radio1) [ -n "$dev_5g" ] && printf '%s\n' "$dev_5g" && return 0 ;;
        radio2) [ -n "$dev_6g" ] && printf '%s\n' "$dev_6g" && return 0 ;;
      esac
      return 1
    }
    {% for radio in gateway_router_wifi_radios_to_disable_effective %}
    resolved_radio="$(resolve_radio '{{ radio }}' || true)"
    if [ -n "$resolved_radio" ]; then
      uci set wireless."$resolved_radio".disabled='1'
    fi
    {% endfor %}
  when:
    - not (gateway_router_test_mode_effective | bool)
    - gateway_router_wan_internet_check.rc == 0
    - gateway_router_wifi_radios_to_disable_effective | length > 0

- name: Commit wireless radio disable changes
  ansible.builtin.raw: |
    uci commit wireless
  when:
    - not (gateway_router_test_mode_effective | bool)
    - gateway_router_wan_internet_check.rc == 0
    - gateway_router_wifi_radios_to_disable_effective | length > 0

- name: Reload Wi-Fi after gateway-router radio disable
  ansible.builtin.raw: |
    wifi reload >/dev/null 2>&1 || true
  when:
    - not (gateway_router_test_mode_effective | bool)
    - gateway_router_wan_internet_check.rc == 0
    - gateway_router_wifi_radios_to_disable_effective | length > 0

- name: Skip radio disable in gateway-router test mode
  ansible.builtin.debug:
    msg: >-
      gateway_router_test_mode is enabled; Wi-Fi radios are kept enabled so repeater
      uplink can provide internet for Tailscale during testing.
  when: gateway_router_test_mode_effective | bool

- name: Keep gateway-router Wi-Fi enabled when WAN/internet not confirmed
  ansible.builtin.debug:
    msg: >-
      WAN/internet was not confirmed, so gateway-router Wi-Fi radios were left enabled.
      Check ifstatus wan and upstream PPPoE link, then rerun to disable radios.
  when:
    - not (gateway_router_test_mode_effective | bool)
    - gateway_router_wan_internet_check.rc != 0
    - gateway_router_wifi_radios_to_disable_effective | length > 0
